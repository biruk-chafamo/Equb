{% extends 'moneypool/new_base.html' %}

{% block content%}

<script>

  changeTabTo("{{current_tab}}")

</script>

<div class="row justify-content-center">
<div class="col-md-7" style="margin: 0px 20px 20px 0px;">
    <div class="row ">
         <div class="col-md-12" style="margin: 0px 0px 20px 0px;
      box-shadow:3px 3px 3px grey; background-color: #fff; border-left: 20px solid white;  border-right: 20px solid white; border-radius: 20px 20px 10px 10px; padding:10px;">
        <div class="row">
            <div class="col-md-12">
            <h5 class="text-muted" style="text-align: left">Approaching Equbs</h5>
                <hr>
                </div>


          </div>


  <div class="row  " style="

  display: flex;
  flex-wrap: nowrap;
  overflow-x: auto;
  overflow-y: hidden;
  ">

      {%for equb in pending|slice:"0::"%}
  <div class="card card-nav-tabs" style="flex-basis: 15%;
  flex-grow: 0;
  flex-shrink: 0;margin:0px 10px 10px 0px; box-shadow:2px 2px 2px grey; border-radius:10px 10px 10px 10px; background-color: rgba(200, 200, 200, .6);">
    <div class=" card-header" style="border-radius:10px 10px 0px 0px; background-color: rgb(123, 168, 183); padding: 10px">

              {{equb.name}}

    </div>
    <div class="card-body" style="padding: 4px">
      <div class="tab-content text-center">
        <div class="tab-pane active" id="{{equb.id}}_status">

          <div class="progress" >
            <div class="progress-bar bg-info" role="progressbar" style="width: {{equb.balance_manager.percent_joined}}%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="card-footer text-muted justify-content-center"
               style="background-color: rgba(200, 200, 200, .6); border-radius: 0 0 10px 10px">
            {{equb.balance_manager.current_spots}} spot/s remaining
          </div>
        </div>
        <div class="tab-pane" id="{{equb.id}}_invite">



        </div>
      </div>
    </div>
  </div>

{% endfor %}
  </div>
         </div>
        </div>
    <div class="row" style="
  margin: 0px 0px 20px 0px;
      box-shadow:3px 3px 3px grey; background-color: #fff; border-radius: 20px 20px 10px 10px; padding:10px;">
        <div class="col-12">
        <div class="row">
          <div class="col-md-7 mr-auto">
            <h3 class='' style="text-align: left">Notifications</h3>
          </div>
          <div class="col-md-5" style="text-align: right">
            <p>
            <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#tobespecified" aria-expanded="false" aria-controls="tobespecified">
              See ALl
            </button>
            </p>

          </div>
        </div>
            <hr>
            <div class="row">
                approaching equbs
                {% for equb in approaching_equbs %}
                    <p>{{equb.name}}</p>
                {% endfor %}
            </div>
             <hr>
            <div class="row">
                equb recommendations
                {% for equb in equb_recs %}
                    <p>{{equb.name}}</p>
                {% endfor %}
            </div>
             <hr>
            <div class="row">
                sent outbids
                {% for outbid in sent_outbids %}
                    <p>{{outbid.sender_message}}</p>
                {% endfor %}
            </div>
             <hr>
            <div class="row">
                received outbids
                {% for outbid in received_outbids %}
                    <p>{{outbid.receiver_message}}</p>
                {% endfor %}
            </div>
             <hr>
            <div class="row">
                equb invites

                <ul>
<!--                {% for equb in equb_invites %}-->
<!--                    <li>{{equb.name}}</li>-->
<!--                {% endfor %}-->
                    </ul>
            </div>
             <hr>
</div>
    </div>
    </div>


<div class="col-md-4">
    <div class="row" >
        <div class="card" style="width:100%; margin: 0px 0px 5px 5px;
      box-shadow:3px 3px 3px grey; border-radius: 20px; padding: 0px 5px 0px 5px;">
            <div class="card-body " style="margin: 0px; padding-left:0px; padding-right:0px">
                <h5 class="card-text text-muted" style="margin-bottom: 0px; margin-left:0">Equb invitations</h5>


                <input class="form-control" id="equb_invitations_listSearch" type="text" placeholder="Search invitations">

                    <ul class="list-group list-group-flush" id="equb_invitations" style="
                height: 200px;
                margin: 0px;
                overflow: overlay;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;">
                    <script>
                        $(document).ready(function(){
                        $("#equb_invitations_listSearch").on("keyup", function() {
                        var value = $(this).val().toLowerCase();
                        $("#equb_invitations li").filter(function() {
                        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                        });
                        });
                    });</script>
                {% for invite in invitations %}
                     <li class="list-group-item invites {{invite.equb.id}}"
                         style="width:100%;border-radius: 10px; margin-bottom:3px; padding: 0px 0px 0px 10px; background-color: {% cycle 'rgb(230, 230, 230)' 'rgb(217, 217, 217)'%}">

                         <div class="row justify-content-between">
                             <div class="col-11">
                                 <p style="margin-top: 10px; margin-bottom: 0px; font-size: 15px">{{invite.equb.name}} <br></p>
                                 <p class="text-muted" style="margin-bottom:3px"> by {{invite.sender.user.username}}
                                 on {{invite.date|date:"SHORT_DATE_FORMAT"}} </p><br>
                             </div>
                         </div>
                             <div class="row justify-content-end">
                                 <div class="{{invite.equb.id}} col-10 ">
                                 <button class="accept-invite" style=" border-radius: 10px 0px 0px 10px; background-color: rgba(214, 245, 214, .5); margin:0px; height:100%">
                                     Accept
                                 </button>

                                 <button class="decline-invite" style=" border-radius: 0px 10px 10px 0px; background-color: rgba(255, 194, 179, .5); margin:0px; height:100%">
                                     Decline
                                 </button>
                                 </div>

                             </div>
                     </li>



                {% endfor %}

            </ul>
                </div>
        </div>


    </div>
    <div class="row" >
        <div class="card" style="width:100%; margin: 5px 5px 5px 5px;
      box-shadow:3px 3px 3px grey; border-radius: 20px; padding: 0px 5px 0px 5px;">
            <div class="row  card-body justify-content-between" style="margin: 0; padding-left:0px; padding-right:0px">
                <div class="col-4">
                    <h5 class="card-text text-muted" style="margin-bottom: 0px; margin-left:0">Bidding</h5>
                </div>
                {% if active_equbs %}
                 <div class="col-6">

                    <select class="live-equb" >
                        {% for equb in active_equbs %}
                        <option value="{{equb.id}}">
                            {{equb.name}}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}


            </div>
                <div id="graph" style="margin: 0px"></div>
                    <ul class="list-group list-group-flush" style="
                height: 200px;

                margin: 0px;
                overflow: overlay;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;">

                {% for outbid in outbids %}
                        {% if outbid.sender == client %}
                     <li class="list-group-item invites {{invite.equb.id}}"
                         style="width:100%;border-radius: 10px; margin-bottom:3px; padding: 0px 0px 0px 10px; background-color: rgba(214, 245, 214, .5);">

                         <div class="row justify-content-between">
                             <div class="col-11">
                                 <p style="margin-top: 10px; margin-bottom: 0px; font-size: 15px">{{outbid.sender_message}} <br></p>
                                 <p class="text-muted" style="margin-bottom:3px">
                                 {{outbid.date|date:"SHORT_DATE_FORMAT"}}
                                 </p><br>

                             </div>
                         </div>

                     </li>
                        {% else %}
                        <li class="list-group-item invites {{invite.equb.id}}"
                         style="width:100%;border-radius: 10px; margin-bottom:3px; padding: 0px 0px 0px 10px; background-color: rgba(255, 194, 179, .5);">

                         <div class="row justify-content-between">
                             <div class="col-11">
                                 <p style="margin-top: 10px; margin-bottom: 0px; font-size: 15px">{{outbid.receiver_message}} <br></p>
                                 <p class="text-muted" style="margin-bottom:3px">
                                 {{outbid.date|date:"SHORT_DATE_FORMAT"}}
                                 </p><br>

                             </div>
                         </div>
                            <div class="row justify-content-end">
                                 <div class="col-10 ">
                                 <button class="counter-bid" style=" border-radius: 10px 10px 10px 10px; background-color: rgba(214, 245, 214, .5); margin:0px; height:100%">
                                     Counter
                                 </button>
                                 </div>

                             </div>

                     </li>

                    {% endif %}

                {% endfor %}

            </ul>
        </div>
    </div>
    </div>
</div>




<div class="test-live"></div>




<script>
$('.accept-invite').click( function(event) {
    var equb_id = $(this).parent()[0].classList[0];

    var data = {csrfmiddlewaretoken: "{{ csrf_token }}", 'equb_id': Number(equb_id)};


  event.preventDefault();
  $.ajax({
    type : "POST",
    url : "{% url 'moneypool:accept_invite' %}",
    csrfmiddlewaretoken: "{{ csrf_token }}",
    data : data,
    success: function(){
        $(`li.invites.${equb_id}`).remove();
      },
    error: function(XMLHttpRequest, textStatus, errorThrown) {
      alert("some error " + String(errorThrown) + String(textStatus) + String(XMLHttpRequest.responseText));
      }
    });
  });

      </script>



    <script src="https://d3js.org/d3.v4.min.js"></script>
<script>

var container
var svg
var g
var linePath

var xScale = d3.scaleLinear()
var yScale = d3.scaleLinear()

var xExtent
var yExtent

var width
var height

var line = d3.line()
  .x(function (d) {
    return xScale(d[0])
  })
  .y(function (d) {
    return yScale(d[1])
  })

var chartData

var data = {{data}}
function bakeChart () {
  container = d3.select('#graph')
    .append("div")
    .attr('id', 'container')

  svg = container
    .append("svg")

  g = svg
    .append('g')

  linePath = g
    .append('path')
    .classed('line', true)
    .datum(chartData)
}

function setValues () {
  var bbox = container.node().getBoundingClientRect()

  yExtent = d3.extent(chartData, function (d) {
    return d[1]
  })
  xExtent = d3.extent(chartData, function (d) {
    return d[0]
  })

  width = bbox.width
  height = bbox.height

  xScale.domain(xExtent)
    .range([0, width])

  yScale.domain(yExtent)
    .range([height, 0])
}

function renderChart () {
  svg.attr("width", width)
    .attr("height", height)

  linePath
    .attr('d', line)
}

function onResize () {
  setValues(chartData)
  renderChart(chartData)
}

loadData('my/data.json', function (d) {
  chartData = d
  bakeChart()
  setValues()

  renderChart()
})

window.addEventListener('resize', onResize)

function loadData (str, cb) {
  cb(data)
}

	</script>
{% endblock %}